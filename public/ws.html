<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>websocket</title>
</head>

<body>
    <input type="text" id="pl" />
    <input type="button" value="发送" id="submit" />
    <input type="button" value="关闭" id="close" />
</body>
<script type="text/javascript" src="js/promise.js"></script>
<script type="text/javascript" src="js/websocket_client.js"></script>
<script type="text/javascript">
    var webSocket = undefined;

    function init() {
        if (webSocket === undefined) {
            webSocket = new websocket("ws://api.my.com/",
                "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjVjOGE0Mzg5MTA4NmJkN2M5Y2ZmMjEwNSIsInRva2VuX3ZlcnNpb24iOjIxLCJleHBfaXNfbG9uZyI6ZmFsc2UsImlhdCI6MTU2Njk3MDM0MywiZXhwIjoxNTY2OTc3NTQzLCJpc3MiOiJodHRwOi8vbG9jYWxob3N0In0.HuE5lHD3FrdL1x5NqDhsVvEZTKyRyisW8aWuSxe0qQU",
                0);
            webSocket.onopen = function(evt) {
                // 一旦连接成功，就发送第一条数据
                //webSocket.send("第一条数据")
            }
            webSocket.onmessage = function(evt) {
                    // 这是服务端返回的数据
                    console.log("服务端说" + evt.data);
                    var data = JSON.parse(evt.data);
                    if (data.code == 0 && data.id) {
                        webSocket.reply("ok");
                    }
                }
                // 关闭连接
            webSocket.onclose = function(evt) {
                console.log("Connection closed.");
            }

            webSocket.onerror = function(evt) {
                console.error(evt);
            }
        }
    }
    // input事件发送数据
    init();
    document.getElementById("submit").onclick = function() {
        var str = document.getElementById("pl").value;
        webSocket.sendAsync('get', '/', {
            message: str
        }).then(function(data) {
            console.log(data);
        }).catch(function(data) {
            console.error(data);
        });
    }
</script>